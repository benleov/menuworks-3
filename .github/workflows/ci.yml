name: CI Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.21']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}

      - name: Version Consistency Check
        run: |
          # Fetch all tags
          git fetch --tags
          
          # Get latest tag (if any)
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -n "$LATEST_TAG" ] && [ -f "VERSION" ]; then
            # Extract version from tag (remove 'v' prefix)
            TAG_VERSION=${LATEST_TAG#v}
            FILE_VERSION=$(cat VERSION | tr -d '[:space:]')
            
            echo "Latest git tag: $LATEST_TAG (version: $TAG_VERSION)"
            echo "VERSION file contents: $FILE_VERSION"
            
            if [ "$TAG_VERSION" != "$FILE_VERSION" ]; then
              echo "ERROR: VERSION file ($FILE_VERSION) does not match latest tag ($TAG_VERSION)"
              echo "This indicates VERSION file is out of sync with git tags."
              echo "The release workflow will sync it automatically on next release."
              # Note: We don't fail CI here as this is expected during development
              # The VERSION file gets synced by release.yml after tag push
            else
              echo "âœ“ VERSION file matches latest tag"
            fi
          else
            echo "Skipping version check (no tags yet or VERSION file missing)"
          fi

      - name: Run tests
        run: |
          go test -v ./config
          go test -v ./menu

      - name: Run build (verify compilation)
        run: |
          GOOS=windows GOARCH=amd64 go build -ldflags "-X main.version=test" -o dist/test-windows.exe cmd/menuworks/main.go
          GOOS=linux GOARCH=amd64 go build -ldflags "-X main.version=test" -o dist/test-linux cmd/menuworks/main.go
          GOOS=darwin GOARCH=amd64 go build -ldflags "-X main.version=test" -o dist/test-macos cmd/menuworks/main.go
          GOOS=darwin GOARCH=arm64 go build -ldflags "-X main.version=test" -o dist/test-macos-arm64 cmd/menuworks/main.go
          echo "All builds succeeded"

      - name: Clean up test binaries
        if: always()
        run: |
          rm -f dist/test-*
